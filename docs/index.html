
<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Husky Jump</title>
<style>
  :root{--bg:#0b1b2a;--fg:#e9f2ff;--panel:#11273d;--accent:#5ec3ff}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Helvetica,Arial,sans-serif}
  #wrap{position:relative;min-height:100vh;display:flex;flex-direction:column}
  #gamewrap{flex:1;display:flex;align-items:center;justify-content:center}
  canvas{display:block;width:100vw;height:100vh;touch-action:manipulation}
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,15,25,.65);z-index:10}
  .box{background:var(--panel);border:1px solid #284963;border-radius:14px;max-width:480px;width:90%;padding:18px 16px;box-shadow:0 12px 40px rgba(0,0,0,.4)}
  .box h2{margin:0 0 8px;font-size:20px}
  .box p{margin:8px 0 0;line-height:1.4}
  .row{display:flex;gap:8px;margin-top:12px}
  input[type=text]{flex:1;padding:10px;border-radius:10px;border:1px solid #466a85;background:#0e2236;color:var(--fg)}
  button,a.btn{appearance:none;border:0;border-radius:10px;background:#1a3d5e;color:var(--fg);padding:10px 14px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
  button:hover,a.btn:hover{background:#235078}
  .btn.secondary{background:#0e2236;border:1px solid #3a5f7c}
  ul.leaders{list-style:none;padding:0;margin:8px 0 0}
  ul.leaders li{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #24465f}
  #jumpBtn{position:fixed;right:14px;bottom:14px;z-index:5;padding:14px 18px;border-radius:14px;background:#2b5a84;color:var(--fg);border:1px solid #3c729f}
  footer{padding:10px 12px;opacity:.85;font-size:12px}
  footer a{color:#9fd2ff}
  ul.inst{margin:8px 0 12px 20px;padding:0}
  ul.inst li{margin:6px 0}
</style>

<div id="wrap">
  <div id="gamewrap">
    <canvas id="game" width="800" height="450"></canvas>
    <button id="jumpBtn" aria-label="Jump" title="Jump">Jump</button>
  </div>

  <footer>
    <div style="max-width:960px;margin:0 auto">
      <span>Husky Jump · Tap/click or press Space/↑ to jump. Double-tap for a double jump. Avoid blocks, collect treats, “hit” a door to visit a page.</span>
      <span style="float:right">
        <a href="https://www.flaticon.com/free-icons/inu" title="inu icons" target="_blank" rel="noopener">Inu icons created by Park Jisun - Flaticon</a>
      </span>
    </div>
  </footer>
</div>

<!-- 1) Name overlay -->
<div id="nameOverlay" class="overlay">
  <div class="box">
    <h2>Welcome!</h2>
    <p>Enter a name (shown on this device’s best score):</p>
    <div class="row">
      <input id="nameInput" type="text" maxlength="24" placeholder="Your name">
      <button id="saveNameBtn">Save</button>
    </div>
  </div>
</div>

<!-- 2) Start/Instructions overlay -->
<div id="startOverlay" class="overlay">
  <div class="box">
    <h2>Husky Jump</h2>
    <p>How to play:</p>
    <ul class="inst">
      <li>Tap/click or press Space/↑ to jump.</li>
      <li>While in the air, tap/click again to double jump.</li>
      <li>Collect treats for bonus points.</li>
      <li>Avoid red blocks.</li>
      <li>Bump into a door to open that page.</li>
    </ul>
    <div class="row" style="justify-content:flex-end">
      <button id="startBtn">Start</button>
    </div>
  </div>
</div>

<!-- 3) Game Over + local best -->
<div id="overOverlay" class="overlay">
  <div class="box">
    <h2 id="overTitle">Game Over</h2>
    <p id="overSubtitle">Score: <span id="finalScore">0</span></p>
    <ul id="topList" class="leaders"></ul>
    <div class="row" style="justify-content:flex-end">
      <a id="doorLink" class="btn secondary" href="#" style="display:none"></a>
      <button id="againBtn">Play again</button>
    </div>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', init);

function init(){
  /* ===== Config (replace URLs with WithJoy links later) ===== */
  const DOORS = [
    { label: "Home",           url: "#", color: "#ffd166" },
    { label: "Schedule",       url: "#", color: "#80ed99" },
    { label: "RSVP",           url: "#", color: "#ef476f" },
    { label: "Accommodations", url: "#", color: "#5ec3ff" }
  ];

  const PLAYER_W = 56, PLAYER_H = 48;
  const FLOOR = 380;
  const GRAVITY = 0.7;
  const JUMP_VELOCITY = -13.5;
  const DOUBLE_JUMP_VELOCITY = -11;
  const SCROLL_SPEED = 4.4;
  const TREAT_POINTS = 50;
  const GROUND_COLOR = "#0f2b45";
  const ICE_COLOR = "#6ed4ff";
  const MAX_LEAVES = 40;
  const SPAWN_BLOCK_EVERY = [900, 1500];
  const SPAWN_TREAT_EVERY = [1200, 2200];
  const SPAWN_DOOR_EVERY  = [8000, 12000];

  /* ===== Canvas + helpers ===== */
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  const jumpBtn = document.getElementById("jumpBtn");
  const nameOverlay = document.getElementById("nameOverlay");
  const startOverlay = document.getElementById("startOverlay");
  const overOverlay = document.getElementById("overOverlay");
  const finalScoreEl = document.getElementById("finalScore");
  const topList = document.getElementById("topList");
  const overTitle = document.getElementById("overTitle");
  const doorLink = document.getElementById("doorLink");
  const againBtn = document.getElementById("againBtn");
  const saveNameBtn = document.getElementById("saveNameBtn");
  const startBtn = document.getElementById("startBtn");
  const nameInput = document.getElementById("nameInput");

  let W = canvas.width, H = canvas.height;
  function rand(min,max){ return Math.random()*(max-min)+min; }
  function chance(p){ return Math.random()<p; }
  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

  /* ===== Assets ===== */
  const huskyImg = new Image();
  huskyImg.src = "assets/husky.png";
  huskyImg.crossOrigin = "anonymous";

  /* ===== Simple sounds ===== */
  const audio = { ctx:null, enabled:true };
  function initAudio(){ if(audio.ctx) return; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return; audio.ctx=new AC(); }
  function tone(f, dur, type='sine', vol=0.08){
    if(!audio.ctx || !audio.enabled) return;
    const ctxA=audio.ctx, o=ctxA.createOscillator(), g=ctxA.createGain();
    o.type=type; o.frequency.value=f; o.connect(g); g.connect(ctxA.destination);
    const now=ctxA.currentTime; g.gain.value=0; o.start(now);
    g.gain.linearRampToValueAtTime(vol, now+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
    o.stop(now+dur+0.02);
  }
  function sfx(name){
    switch(name){
      case 'jump':  tone(620,0.12,'square',0.08); break;
      case 'jump2': tone(740,0.12,'square',0.07); break;
      case 'treat': tone(900,0.08,'triangle',0.07); tone(1200,0.10,'triangle',0.05); break;
      case 'hit':   tone(180,0.20,'sawtooth',0.12); break;
      case 'door':  tone(520,0.14,'square',0.08); tone(650,0.16,'square',0.06); break;
    }
  }
  addEventListener("pointerdown", ()=>{ initAudio(); }, { once:true });
  addEventListener("keydown", ()=>{ initAudio(); }, { once:true });

  /* ===== Game state ===== */
  let started = false;   // only true after Start
  let running = false;   // true during an active run

  let player, objects, leaves, score, nextBlockAt, nextTreatAt, nextDoorAt, doorIndex, canDouble;
  let lastTs=0;

  function resetGame(){
    score = 0;
    running = true;
    doorIndex = 0;
    canDouble = false;
    player = { x:120, y:FLOOR-PLAYER_H, w:PLAYER_W, h:PLAYER_H, vy:0, onGround:true, facing:1 };
    objects = [];
    leaves = [];
    const now = performance.now();
    nextBlockAt = now + rand(...SPAWN_BLOCK_EVERY);
    nextTreatAt = now + rand(...SPAWN_TREAT_EVERY);
    nextDoorAt  = now + rand(...SPAWN_DOOR_EVERY);
  }

  function jump(){
    if (!running || !started) return;
    if (player.onGround){
      player.vy = JUMP_VELOCITY;
      player.onGround = false;
      canDouble = true;
      sfx('jump');
    } else if (canDouble){
      player.vy = DOUBLE_JUMP_VELOCITY;
      canDouble = false;
      sfx('jump2');
    }
  }

  function spawnBlock(){
    const h = rand(38, 94);
    const w = rand(30, 48);
    const yTop = FLOOR - h;
    objects.push({ type:"block", x: W + 40, y: yTop, w, h, color:"#d9534f" });
  }
  function spawnTreat(){
    const y = rand(150, FLOOR - 80);
    objects.push({ type:"treat", x: W + 40, y, w: 18, h: 18, color:"#ffd166" });
  }
  function spawnDoor(){
    const d = DOORS[doorIndex % DOORS.length]; doorIndex++;
    const doorW = 34, doorH = 58;
    const platformY = rand(FLOOR - 110, FLOOR - 60);
    objects.push({ type:"door", label:d.label, url:d.url, color:d.color, x: W + 60, y: platformY - doorH, w: doorW, h: doorH });
    objects.push({ type:"platform", x: W + 60 - 40, y: platformY, w: 120, h: 14, color: ICE_COLOR });
  }
  function spawnLeaf(){
    if (leaves.length >= MAX_LEAVES) return;
    leaves.push({ x: rand(0,W), y: -20, vy: rand(0.6,1.4), amp: rand(8,18), phase: rand(0,Math.PI*2), size: rand(6,12), hue: Math.floor(rand(20,40))*10 });
  }
  function aabb(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

  function update(dt){
    // ambient leaves even if not started
    if (chance(0.2)) spawnLeaf();
    for (const l of leaves){ l.phase += 0.03; l.x += Math.sin(l.phase)*0.8; l.y += l.vy; }
    leaves = leaves.filter(l => l.y < H + 30);

    if (!running || !started) return;

    // score & physics
    score += SCROLL_SPEED * dt * 0.1;
    player.vy += GRAVITY;
    player.y  += player.vy;
    if (player.y >= FLOOR - PLAYER_H){
      player.y = FLOOR - PLAYER_H; player.vy = 0; player.onGround = true;
    }

    // spawns
    const now = performance.now();
    if (now >= nextBlockAt){ spawnBlock(); nextBlockAt = now + rand(...SPAWN_BLOCK_EVERY); }
    if (now >= nextTreatAt){ spawnTreat(); nextTreatAt = now + rand(...SPAWN_TREAT_EVERY); }
    if (now >= nextDoorAt){  spawnDoor();  nextDoorAt  = now + rand(...SPAWN_DOOR_EVERY); }

    // move & cleanup
    for (const o of objects){ o.x -= SCROLL_SPEED; }
    objects = objects.filter(o => o.x + o.w > -40);

    // collisions
    for (let i=0;i<objects.length;i++){
      const o = objects[i];
      if ((o.type === "platform" || o.type === "door" || o.type === "block") && aabb(player,o)){
        if (o.type === "block"){ sfx('hit'); endRun("You hit a block!"); return; }
        if (o.type === "door"){ sfx('door'); endRun(`You reached ${o.label}`, o); return; }
      } else if (o.type === "treat" && aabb(player,o)){
        score += TREAT_POINTS; sfx('treat'); objects.splice(i,1); i--;
      }
    }
  }

  function draw(){
    // winter gradient
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,"#0a2239"); g.addColorStop(1,"#163a59");
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

    // ground
    ctx.fillStyle = GROUND_COLOR; ctx.fillRect(0, FLOOR+8, W, H-(FLOOR+8));
    ctx.fillStyle = ICE_COLOR; ctx.fillRect(0, FLOOR-10, W, 6);

    // leaves
    for (const l of leaves){
      ctx.fillStyle = `hsl(${l.hue} 70% 60%)`;
      ctx.beginPath(); ctx.ellipse(l.x,l.y,l.size*0.7,l.size*0.4,Math.sin(l.phase)*0.5,0,Math.PI*2); ctx.fill();
    }

    // objects
    for (const o of objects){
      if (o.type === "block" || o.type === "platform"){
        ctx.fillStyle = o.color; roundRect(ctx, o.x, o.y, o.w, o.h, 4, true, false);
      } else if (o.type === "door"){
        ctx.fillStyle = o.color; roundRect(ctx, o.x, o.y, o.w, o.h, 6, true, false);
        ctx.fillStyle = "#173554"; roundRect(ctx, o.x+8, o.y+8, o.w-16, o.h-16, 4, true, false);
        ctx.fillStyle = "#cfe9ff"; ctx.font = "12px system-ui"; ctx.textAlign="center";
        ctx.fillText(o.label, o.x + o.w/2, o.y - 8);
      } else if (o.type === "treat"){
        ctx.fillStyle = o.color; roundRect(ctx, o.x, o.y, o.w, o.h, 6, true, false);
        ctx.fillStyle = "#b9923b"; ctx.fillRect(o.x+5, o.y+7, o.w-10, 4);
      }
    }

    // player (only when started)
    if (started){
      if (huskyImg.complete && huskyImg.naturalWidth){
        ctx.save(); ctx.translate(player.x + player.w/2, player.y + player.h/2); ctx.scale(player.facing,1);
        ctx.drawImage(huskyImg, -player.w/2, -player.h/2, player.w, player.h); ctx.restore();
      } else {
        ctx.fillStyle = "#eef7ff"; roundRect(ctx, player.x, player.y, player.w, player.h, 6, true, false);
      }
    }

    // HUD during run
    if (running && started){
      ctx.fillStyle = "#cfe9ff"; ctx.font = "16px system-ui"; ctx.textAlign="left";
      ctx.fillText("Score: " + Math.floor(score), 14, 22);
    }
  }

  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    if (w < 2*r) r = w/2; if (h < 2*r) r = h/2;
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,  x+w,y+h, r);
    ctx.arcTo(x+w,y+h,x,  y+h, r);
    ctx.arcTo(x,  y+h,x,  y,   r);
    ctx.arcTo(x,  y,  x+w,y,   r);
    if (fill) ctx.fill(); if (stroke) ctx.stroke();
  }

  /* ===== End run + local best ===== */
  function endRun(title, door){
    running = false;
    finalScoreEl.textContent = Math.floor(score);
    overTitle.textContent = title || "Game Over";
    if (door){ doorLink.style.display=""; doorLink.textContent=`Go to ${door.label}`; doorLink.href=door.url; }
    else { doorLink.style.display="none"; }

    const you = (localStorage.getItem("hj_name") || "Guest").slice(0,24);
    const best = Math.max(Math.floor(score), +localStorage.getItem("hj_best")||0);
    localStorage.setItem("hj_best", best);
    topList.innerHTML = "";
    const li = document.createElement("li");
    const left = document.createElement("span"); left.textContent = `1. ${you}`;
    const right = document.createElement("strong"); right.textContent = best;
    li.appendChild(left); li.appendChild(right); topList.appendChild(li);

    showOverlay(overOverlay, true);
  }

  function showOverlay(el, on){ el.style.display = on ? "flex" : "none"; }
  function anyOverlayOpen(){
    return nameOverlay.style.display === "flex" ||
           startOverlay.style.display === "flex" ||
           overOverlay.style.display === "flex";
  }

  /* ===== Loop ===== */
  function frame(ts){
    if (!lastTs) lastTs = ts;
    const dt = clamp((ts - lastTs) / 16.6667, 0, 2);
    lastTs = ts;
    update(dt);
    draw();
    requestAnimationFrame(frame);
  }

  /* ===== Input (ignored while overlays open) ===== */
  addEventListener("keydown", e=>{
    if (anyOverlayOpen()) return;
    if (e.code === "Space" || e.code === "ArrowUp"){ e.preventDefault(); jump(); }
  });
  addEventListener("pointerdown", e=>{
    if (e.target.closest(".overlay") || e.target.id === "againBtn") return;
    if (anyOverlayOpen()) return;
    jump();
  });
  jumpBtn.addEventListener("click", ()=>{ if(!anyOverlayOpen()) jump(); });

  againBtn.addEventListener("click", ()=>{
    showOverlay(overOverlay,false);
    // immediate restart; to show instructions again, swap to:
    // showOverlay(startOverlay,true); started=false; running=false;
    resetGame();
  });

  /* ===== Name + Start flow ===== */
  const savedName = localStorage.getItem("hj_name") || "";
  if (savedName) nameInput.value = savedName;

  saveNameBtn.addEventListener("click", ()=>{
    const v = (nameInput.value||"").trim();
    if (!v) return;
    localStorage.setItem("hj_name", v.slice(0,24));
    showOverlay(nameOverlay, false);
    showOverlay(startOverlay, true);
  });
  nameInput.addEventListener("keydown", (e)=>{
    if (e.key === "Enter") saveNameBtn.click();
  });

  startBtn.addEventListener("click", ()=>{
    initAudio();     // unlock audio
    started = true;
    showOverlay(startOverlay, false);
    resetGame();     // begin first run
  });

  // Show overlays; do not start the game yet
  if (!localStorage.getItem("hj_name")) showOverlay(nameOverlay, true);
  else showOverlay(startOverlay, true);

  // Kick off rendering (game logic will idle until Start)
  requestAnimationFrame(frame);
} // end init
</script>
